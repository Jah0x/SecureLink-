# Лог разработки

- Заменены все упоминания Mocha на Hunko.
- Реализована собственная система аутентификации через сервер Hunko.
- Добавлен скрипт установки `install.sh`.
- Создан Kubernetes-манифест `k8s/deployment.yaml`.
- Обновлена документация и зависимости проекта.
- Проверена установка зависимостей, исправлены ошибки сборки, добавлены типы пользователя и статистики партнёров.
- Настроены локальные статические ресурсы и обновлён манифест для собственного сервиса Hunko.
- Удалены бинарные иконки из репозитория; добавлены инструкции по их ручному размещению в каталоге `public/`.
- Добавлены маршруты совместимости для OAuth (`/auth/authorisationurl`, `/thirdparty/:provider/redirect_url`) и health-check `/healthz`.
- В `AuthProvider` вынесен базовый URL API в переменную `NEXT_PUBLIC_API_BASE_URL`.
- Настроен `vite.config.ts` для поддержки `NEXT_PUBLIC_*` переменных.
- Исправлено формирование OAuth URL: теперь используется `/thirdparty/authorisationurl` с передачей `redirectURIOnProviderDashboard`, что корректно перенаправляет пользователя после входа через Google.
- Добавлен фолбэк для `getOAuthRedirectUrl` с поддержкой параметра `redirect_url` и внутренних адресов Hanko, что убирает ошибку `Invalid URL string`.
- Реализована авторизация по email и паролю, добавлена страница регистрации в том же дизайне, что и страница входа.
- Переработан OAuth‑флоу: теперь обмен кода на сессию идёт через `/api/sessions`, куки ставятся с `SameSite=Lax`, а `GET /api/users/me` обращается к Hanko.
- Формы входа и регистрации используют `credentials: include`, показывают ошибки и спиннеры.
- Dev-скрипт запускает одновременно API и Vite с помощью `concurrently`.
- Добавлены алиасы TypeScript `@/worker` и обновлены `tsconfig` файлы.
- Kubernetes-манифест теперь использует порт 5173 и проверку `/healthz` в liveness/readiness‑пробах.
- Обновлены `.env.example` и `README.md` с описанием обязательных переменных и новых портов.
- Добавлен helper `parseOrigin` и переработано формирование OAuth-ссылки без ошибок.
- Вынесен клиент `hankoClient` с обработкой ошибок и установкой HttpOnly-куки.
- API `/api/sessions`, `/api/users/me` и `/api/logout` используют новый клиент и имя куки из окружения.
- Фронтенд обрабатывает ошибки OAuth/парольного входа, всегда передаёт `credentials: include` и имеет фолбэк редиректа `/`.
- README дополнен разделами про единый домен и смоук‑тесты; `.env.example` включает имя куки.
- Настроена выдача SPA: health-check переведён на `/healthz`, статика раздаётся из `dist/client`, добавлен SPA-фолбэк.
- Фиксирован корневой маршрут: `GET /` всегда отдаёт HTML с корректным `Content-Type`, `HEAD /` проверяется смоук-тестом; `/healthz` возвращает JSON и сохранён SPA-фолбэк.
- Добавлено автоопределение каталога сборки (`dist/client` или `dist`), единый SPA‑фолбэк и проверка `HEAD`‑заголовков.
- Статика теперь раздаётся через `@hono/node-server/serve-static`, документация обновлена.
- Добавлены прокси `/api/auth/register`, `/api/auth/login`, `/api/auth/logout` и `/api/users/me` к сервису AUTH с установкой HttpOnly-куки на `.zerologsvpn.com`; реализован OAuth helper `/thirdparty/:provider/redirect_url`; обновлён `.env.example` с настройками куки и путей AUTH; README дополнен инструкциями по проверкам `npm run build && npm run smoke:head`.
- Полностью убрана интеграция Hanko/SSO: удалены маршруты `/thirdparty/*`, введены переменные `AUTH_BASE_URL` и `AUTH_PATH_*`, фронтенд использует только формы email/пароль.
- Добавлена внутренняя аутентификация на SQLite/argon2 с JWT‑сессиями и опциональным проксированием во внешний AUTH.
- Реализованы роли пользователей с колонкой `role`, инициализацией администраторов через переменные окружения и мидлварами `requireAuth`/`requireAdmin`; добавлен эндпоинт `/api/admin/ping` и защита раздела админки на фронтенде.
- Добавлена таблица тарифных планов с публичным и админским API для управления планами; фронтенд отображает доступные планы и позволяет администратору создавать и редактировать их.
- Реализован полный CRUD тарифных планов с фильтрами и активацией/деактивацией, обновлены публичные и админские UI; добавлена обработка отключённой интеграции Marzban.
- Исправлены импорты иконок Lucide на странице Pricing, включено правило ESLint `react/jsx-no-undef` для предотвращения неимпортированных JSX-компонентов.
- Добавлены API и UI админки для списка пользователей с куками, фильтр тарифов стал устойчивым к значениям `active`, реализована минимальная партнёрская программа: трекинг ссылок, статистика `/api/aff/me` и редирект `/r/:code`; на фронтенде введён единый `apiFetch` и переработаны страницы админки и «Заработка».
- Проект переведён на Drizzle ORM с поддержкой PostgreSQL и SQLite; добавлены конфигурация, клиент и схема БД, запросы переписаны на новый драйвер.
- Реализован сид первого администратора через `FIRST_ADMIN_EMAIL`/`FIRST_ADMIN_PASSWORD`, миграции Drizzle выполняются в `bootstrap.sh` при старте контейнера, обновлены манифесты Kubernetes и документация.
- Перенесён `drizzle-kit` в dev-зависимости, добавлены скрипты `db:gen`/`db:push`, ConfigMap запускает миграции и приложение через `tsx` и `_runner.ts`, пример `.env` теперь использует PostgreSQL и сидер первого администратора документирован.
- Добавлены таблицы `plan_features`, `affiliate_links`, `affiliate_stats` с индексами по (`user_id`, `created_at`) и (`ref_id`, `created_at`); эндпоинты `/api/admin/plans` и `/api/aff/me` возвращают пустые ответы без ошибок, добавлены `/api/aff/stats` и список аффилиатов в админке.
- Переписаны миграции: заменены устаревшие таблицы `vpn_*` на новую схему `users`, `plans`, `plan_features`, `subscriptions`, `affiliates`, `affiliate_clicks`, `affiliate_links`, `affiliate_stats` в `drizzle/0000_initial.sql`.

- При старте воркера теперь автоматически выполняются миграции Drizzle, что гарантирует создание таблиц тарифов и реферальной системы до сидирования первого администратора.

- Обновлён пакет `drizzle-orm` до версии 0.44.4 для устранения ошибки отсутствующей зависимости.
- Обновлён `drizzle-kit` до версии 0.31.4, устаревшие зависимости заменены на `tsx`, миграции выполняются без ошибки про отсутствующий `drizzle-orm`.
- Добавлен файл `drizzle/meta/_journal.json` для устранения ошибки миграций.
- Миграции Drizzle выполняются через `safeMigrate` с возможностью пропуска в проде и игнорированием существующей схемы; в Deployment добавлена переменная `SKIP_RUNTIME_MIGRATIONS`.
- Добавлен `src/_runner.ts` с запуском Hono-сервера без автоматических миграций; миграции и сид выполняются только при `MIGRATE_ON_BOOT=1`, обновлены скрипты запуска и манифесты Kubernetes.

- Реализован полноценный Docker-образ без bootstrap: Node-сервер на http с /healthz, ленивые миграции Drizzle через флаг `MIGRATE_ON_BOOT`, отдельный Job для миграций в k8s, CI публикует образ в ghcr.
- Исправлена проксировка POST/PUT в Node 20: для стримовых тел добавлен `duplex: 'half'` и опциональная буферизация через `USE_BUFFERED_BODY`.
- Обновлена сборка: добавлены Dockerfile/dev и docker-compose для разработки, CI публикует образ в GHCR, k8s-манифесты очищены от bootstrap.
- Node-сервер динамически монтирует Hono-worker через `hono/adapter`, устраняя 404 на `/api/*` и сохраняя раздачу статики и `GET /healthz`.
- Настроены алиасы TypeScript `@/*` с постобработкой `tsc-alias`, сборка выполняет `tsc`, `tsc-alias` и `vite`; сервер монтирует worker до статики, что устраняет 404 API.
- Исправлен динамический импорт воркера через нативный `import()` в `src/server/index.ts`, что обходит понижение до `require()`; подтверждена сборка фронтенда в `dist/client`.
- Перешли на `tscpaths` вместо `tsc-alias`, сборка выполняется как `tsc` → `tscpaths` → `vite`; Dockerfile стал двухэтапным с запуском от non-root и `HEALTHCHECK`; CI собирает образ, смоук‑тестирует `/healthz` и `/api/*` и публикует теги `latest` и `sha-<commit>`.
- Исправлены импорты воркера: все ссылки вида `@/db/*` заменены на относительные пути, сервер гарантированно монтирует ESM-воркер перед раздачей статики; CI проверяет отсутствие алиасов и 404 на `/api/auth/login`.
- Реализована ленивая инициализация БД: воркер и маршруты `/api/*` монтируются без ошибки при отсутствии переменной `DB`, хендлеры отвечают `503 (DB not configured)` без падения сервера.
