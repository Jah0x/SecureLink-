# Лог разработки

- Заменены все упоминания Mocha на Hunko.
- Реализована собственная система аутентификации через сервер Hunko.
- Добавлен скрипт установки `install.sh`.
- Создан Kubernetes-манифест `k8s/deployment.yaml`.
- Обновлена документация и зависимости проекта.
- Проверена установка зависимостей, исправлены ошибки сборки, добавлены типы пользователя и статистики партнёров.
- Настроены локальные статические ресурсы и обновлён манифест для собственного сервиса Hunko.
- Удалены бинарные иконки из репозитория; добавлены инструкции по их ручному размещению в каталоге `public/`.
- Добавлены маршруты совместимости для OAuth (`/auth/authorisationurl`, `/thirdparty/:provider/redirect_url`) и health-check `/healthz`.
- В `AuthProvider` вынесен базовый URL API в переменную `NEXT_PUBLIC_API_BASE_URL`.
- Настроен `vite.config.ts` для поддержки `NEXT_PUBLIC_*` переменных.
- Исправлено формирование OAuth URL: теперь используется `/thirdparty/authorisationurl` с передачей `redirectURIOnProviderDashboard`, что корректно перенаправляет пользователя после входа через Google.
- Добавлен фолбэк для `getOAuthRedirectUrl` с поддержкой параметра `redirect_url` и внутренних адресов Hanko, что убирает ошибку `Invalid URL string`.
- Реализована авторизация по email и паролю, добавлена страница регистрации в том же дизайне, что и страница входа.
- Переработан OAuth‑флоу: теперь обмен кода на сессию идёт через `/api/sessions`, куки ставятся с `SameSite=Lax`, а `GET /api/users/me` обращается к Hanko.
- Формы входа и регистрации используют `credentials: include`, показывают ошибки и спиннеры.
- Dev-скрипт запускает одновременно API и Vite с помощью `concurrently`.
- Добавлены алиасы TypeScript `@/worker` и обновлены `tsconfig` файлы.
- Kubernetes-манифест теперь использует порт 5173 и проверку `/healthz` в liveness/readiness‑пробах.
- Обновлены `.env.example` и `README.md` с описанием обязательных переменных и новых портов.
- Добавлен helper `parseOrigin` и переработано формирование OAuth-ссылки без ошибок.
- Вынесен клиент `hankoClient` с обработкой ошибок и установкой HttpOnly-куки.
- API `/api/sessions`, `/api/users/me` и `/api/logout` используют новый клиент и имя куки из окружения.
- Фронтенд обрабатывает ошибки OAuth/парольного входа, всегда передаёт `credentials: include` и имеет фолбэк редиректа `/`.
- README дополнен разделами про единый домен и смоук‑тесты; `.env.example` включает имя куки.
- Настроена выдача SPA: health-check переведён на `/healthz`, статика раздаётся из `dist/client`, добавлен SPA-фолбэк.
- Фиксирован корневой маршрут: `GET /` всегда отдаёт HTML с корректным `Content-Type`, `HEAD /` проверяется смоук-тестом; `/healthz` возвращает JSON и сохранён SPA-фолбэк.
- Добавлено автоопределение каталога сборки (`dist/client` или `dist`), единый SPA‑фолбэк и проверка `HEAD`‑заголовков.
- Статика теперь раздаётся через `@hono/node-server/serve-static`, документация обновлена.
- Добавлены прокси `/api/auth/register`, `/api/auth/login`, `/api/auth/logout` и `/api/users/me` к сервису AUTH с установкой HttpOnly-куки на `.zerologsvpn.com`; реализован OAuth helper `/thirdparty/:provider/redirect_url`; обновлён `.env.example` с настройками куки и путей AUTH; README дополнен инструкциями по проверкам `npm run build && npm run smoke:head`.
- Полностью убрана интеграция Hanko/SSO: удалены маршруты `/thirdparty/*`, введены переменные `AUTH_BASE_URL` и `AUTH_PATH_*`, фронтенд использует только формы email/пароль.
- Добавлена внутренняя аутентификация на SQLite/argon2 с JWT‑сессиями и опциональным проксированием во внешний AUTH.
- Реализованы роли пользователей с колонкой `role`, инициализацией администраторов через переменные окружения и мидлварами `requireAuth`/`requireAdmin`; добавлен эндпоинт `/api/admin/ping` и защита раздела админки на фронтенде.
- Добавлена таблица тарифных планов с публичным и админским API для управления планами; фронтенд отображает доступные планы и позволяет администратору создавать и редактировать их.
- Реализован полный CRUD тарифных планов с фильтрами и активацией/деактивацией, обновлены публичные и админские UI; добавлена обработка отключённой интеграции Marzban.
- Исправлены импорты иконок Lucide на странице Pricing, включено правило ESLint `react/jsx-no-undef` для предотвращения неимпортированных JSX-компонентов.
- Добавлены API и UI админки для списка пользователей с куками, фильтр тарифов стал устойчивым к значениям `active`, реализована минимальная партнёрская программа: трекинг ссылок, статистика `/api/aff/me` и редирект `/r/:code`; на фронтенде введён единый `apiFetch` и переработаны страницы админки и «Заработка».
- Проект переведён на Drizzle ORM с поддержкой PostgreSQL и SQLite; добавлены конфигурация, клиент и схема БД, запросы переписаны на новый драйвер.
- Реализован сид первого администратора через `FIRST_ADMIN_EMAIL`/`FIRST_ADMIN_PASSWORD`, миграции Drizzle выполняются в `bootstrap.sh` при старте контейнера, обновлены манифесты Kubernetes и документация.
